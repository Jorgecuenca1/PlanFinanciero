{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'evaluacion:sedes_evaluar' %}">Sedes</a></li>
<li class="breadcrumb-item"><a href="{% url 'evaluacion:sede_categorias' sede_pk=sede.pk %}">{{ sede.nombre }}</a></li>
<li class="breadcrumb-item active">Configuracion</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <h2><i class="bi bi-gear"></i> {{ titulo }}</h2>
        <p class="text-muted">
            Configure los grupos de criterios que seran evaluados en esta sede.
            El grupo <strong>11.1 - Estandares y Criterios Aplicables a Todos los Servicios</strong> es obligatorio.
        </p>
    </div>
</div>

<form method="post">
    {% csrf_token %}

    <div class="row">
        {% for item in grupos_data %}
        <div class="col-md-6 col-lg-4 mb-4">
            <div class="card h-100 {% if item.activo %}border-primary{% endif %}">
                <div class="card-header {% if item.activo %}bg-primary text-white{% else %}bg-light{% endif %}">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" name="grupos"
                               value="{{ item.grupo.pk }}"
                               id="grupo_{{ item.grupo.pk }}"
                               {% if item.activo %}checked{% endif %}
                               {% if item.es_obligatorio %}disabled checked{% endif %}>
                        <label class="form-check-label fw-bold" for="grupo_{{ item.grupo.pk }}">
                            {{ item.grupo.codigo }}
                        </label>
                    </div>
                </div>
                <div class="card-body">
                    <h6 class="card-title">{{ item.grupo.nombre }}</h6>
                    {% if item.grupo.descripcion %}
                    <p class="card-text small text-muted">{{ item.grupo.descripcion|truncatewords:30 }}</p>
                    {% endif %}

                    <div class="mt-3">
                        <span class="badge bg-info">{{ item.estandares_count }} estandares</span>
                        <span class="badge bg-secondary">{{ item.criterios_count }} criterios</span>
                    </div>

                    {% if item.es_obligatorio %}
                    <div class="mt-2">
                        <span class="badge bg-warning text-dark">
                            <i class="bi bi-lock-fill"></i> Obligatorio
                        </span>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="row mt-4">
        <div class="col-12">
            <div class="d-flex justify-content-between">
                <a href="{% url 'evaluacion:sede_categorias' sede_pk=sede.pk %}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
                <button type="submit" class="btn btn-primary">
                    <i class="bi bi-check-lg"></i> Guardar Configuracion
                </button>
            </div>
        </div>
    </div>
</form>

<!-- Asegurar que el grupo obligatorio siempre se envie -->
<script>
document.querySelector('form').addEventListener('submit', function(e) {
    // Habilitar temporalmente el checkbox obligatorio para que se envie
    const obligatorio = document.querySelector('input[type="checkbox"][disabled]');
    if (obligatorio) {
        obligatorio.disabled = false;
    }
});
</script>
{% endblock %}

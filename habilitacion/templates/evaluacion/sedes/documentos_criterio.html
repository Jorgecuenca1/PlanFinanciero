{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'evaluacion:sedes_evaluar' %}">Sedes</a></li>
<li class="breadcrumb-item"><a href="{% url 'evaluacion:sede_categorias' sede_pk=sede.pk %}">{{ sede.nombre }}</a></li>
<li class="breadcrumb-item active">Documentos</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
                <h2><i class="bi bi-folder2-open"></i> {{ titulo }}</h2>
                <p class="text-muted mb-0">
                    <strong>Criterio {{ criterio.numero }}:</strong> {{ criterio.texto|truncatewords:30 }}
                </p>
            </div>
            <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
        </div>
    </div>
</div>

<!-- Informacion del Criterio -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informacion del Criterio</h6>
    </div>
    <div class="card-body">
        <p class="mb-2">{{ criterio.texto }}</p>
        {% if criterio.complejidad_aplica %}
        <span class="badge bg-info">Complejidad: {{ criterio.complejidad_aplica }}</span>
        {% endif %}
        {% if criterio.modalidad_aplica %}
        <span class="badge bg-secondary">Modalidad: {{ criterio.modalidad_aplica }}</span>
        {% endif %}

        <hr>

        <div class="row">
            <div class="col-auto">
                <strong>Estado:</strong>
                <span class="badge {% if evaluacion.estado == 'C' %}bg-success{% elif evaluacion.estado == 'NC' %}bg-danger{% elif evaluacion.estado == 'NA' %}bg-secondary{% else %}bg-warning text-dark{% endif %}">
                    {{ evaluacion.get_estado_display }}
                </span>
            </div>
            <div class="col-auto">
                <strong>Sede:</strong> {{ sede.nombre }}
            </div>
        </div>
    </div>
</div>

<!-- Subir Documento -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0"><i class="bi bi-upload"></i> Subir Documento</h6>
    </div>
    <div class="card-body">
        <form id="formSubirArchivo" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Archivo</label>
                    <input type="file" class="form-control" id="archivo" name="archivo" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Nombre (opcional)</label>
                    <input type="text" class="form-control" id="nombreArchivo" name="nombre"
                           placeholder="Si no se especifica, se usa el nombre del archivo">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Descripcion (opcional)</label>
                    <input type="text" class="form-control" id="descripcionArchivo" name="descripcion">
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-upload"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Lista de Documentos -->
<div class="card">
    <div class="card-header bg-white">
        <h6 class="mb-0">
            <i class="bi bi-files"></i> Documentos Subidos
            <span class="badge bg-primary">{{ archivos.count }}</span>
        </h6>
    </div>
    {% if archivos %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Nombre</th>
                    <th>Descripcion</th>
                    <th>Fecha</th>
                    <th>Subido por</th>
                    <th style="width: 120px;">Acciones</th>
                </tr>
            </thead>
            <tbody id="listaArchivos">
                {% for archivo in archivos %}
                <tr id="archivo-{{ archivo.pk }}">
                    <td>
                        {% if archivo.es_imagen %}
                        <i class="bi bi-file-image text-success"></i>
                        {% elif archivo.es_pdf %}
                        <i class="bi bi-file-pdf text-danger"></i>
                        {% else %}
                        <i class="bi bi-file-earmark"></i>
                        {% endif %}
                        <a href="{{ archivo.archivo.url }}" target="_blank">{{ archivo.nombre }}</a>
                    </td>
                    <td class="text-muted small">{{ archivo.descripcion|default:"-" }}</td>
                    <td class="small">{{ archivo.fecha_subida|date:"d/m/Y H:i" }}</td>
                    <td class="small">{{ archivo.subido_por.nombre_completo|default:archivo.subido_por.email }}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ archivo.archivo.url }}" class="btn btn-outline-primary" target="_blank"
                               title="Descargar">
                                <i class="bi bi-download"></i>
                            </a>
                            <button type="button" class="btn btn-outline-danger"
                                    onclick="eliminarArchivo({{ archivo.pk }})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card-body text-center text-muted">
        <i class="bi bi-folder2 display-4"></i>
        <p class="mt-2">No hay documentos subidos para este criterio.</p>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
const csrfToken = '{{ csrf_token }}';

document.getElementById('formSubirArchivo').addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('{% url "evaluacion:api_subir_archivo" evaluacion_pk=evaluacion.pk %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Agregar fila a la tabla
            const tbody = document.getElementById('listaArchivos');
            if (!tbody) {
                location.reload();
                return;
            }

            const tr = document.createElement('tr');
            tr.id = 'archivo-' + data.archivo.id;
            tr.innerHTML = `
                <td>
                    <i class="bi bi-file-earmark"></i>
                    <a href="${data.archivo.url}" target="_blank">${data.archivo.nombre}</a>
                </td>
                <td class="text-muted small">-</td>
                <td class="small">${data.archivo.fecha}</td>
                <td class="small">{{ user.nombre_completo|default:user.email }}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="${data.archivo.url}" class="btn btn-outline-primary" target="_blank">
                            <i class="bi bi-download"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="eliminarArchivo(${data.archivo.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.insertBefore(tr, tbody.firstChild);

            // Limpiar formulario
            this.reset();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al subir el archivo');
    });
});

function eliminarArchivo(archivoId) {
    if (!confirm('Esta seguro de eliminar este archivo?')) return;

    fetch(`/evaluacion/api/eliminar-archivo/${archivoId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('archivo-' + archivoId).remove();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}

{% extends 'base.html' %}

{% block title %}{{ titulo }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos para preview de documentos */
    #previewContainer .word-content {
        padding: 20px;
        background: white;
        max-height: 70vh;
        overflow-y: auto;
        text-align: left;
    }
    #previewContainer .word-content img {
        max-width: 100%;
    }
    #previewContainer .excel-content {
        padding: 10px;
        max-height: 70vh;
        overflow: auto;
    }
    #previewContainer .excel-content table {
        border-collapse: collapse;
        width: 100%;
        font-size: 12px;
    }
    #previewContainer .excel-content th,
    #previewContainer .excel-content td {
        border: 1px solid #dee2e6;
        padding: 4px 8px;
        text-align: left;
    }
    #previewContainer .excel-content th {
        background-color: #f8f9fa;
        font-weight: bold;
    }
    #previewContainer .excel-content tr:nth-child(even) {
        background-color: #f8f9fa;
    }
    .preview-loading {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 50vh;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'evaluacion:sedes_evaluar' %}">Sedes</a></li>
<li class="breadcrumb-item"><a href="{% url 'evaluacion:sede_categorias' sede_pk=sede.pk %}">{{ sede.nombre }}</a></li>
<li class="breadcrumb-item active">Documentos</li>
{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start flex-wrap gap-2">
            <div>
                <h2><i class="bi bi-folder2-open"></i> {{ titulo }}</h2>
                <p class="text-muted mb-0">
                    <strong>Criterio {{ criterio.numero }}:</strong> {{ criterio.texto|truncatewords:30 }}
                </p>
            </div>
            <button type="button" class="btn btn-outline-secondary" onclick="history.back()">
                <i class="bi bi-arrow-left"></i> Volver
            </button>
        </div>
    </div>
</div>

<!-- Informacion del Criterio -->
<div class="card mb-4">
    <div class="card-header bg-light">
        <h6 class="mb-0"><i class="bi bi-info-circle"></i> Informacion del Criterio</h6>
    </div>
    <div class="card-body">
        <p class="mb-2">{{ criterio.texto }}</p>
        {% if criterio.complejidad_aplica %}
        <span class="badge bg-info">Complejidad: {{ criterio.complejidad_aplica }}</span>
        {% endif %}
        {% if criterio.modalidad_aplica %}
        <span class="badge bg-secondary">Modalidad: {{ criterio.modalidad_aplica }}</span>
        {% endif %}

        <hr>

        <div class="row">
            <div class="col-auto">
                <strong>Estado:</strong>
                <span class="badge {% if evaluacion.estado == 'C' %}bg-success{% elif evaluacion.estado == 'NC' %}bg-danger{% elif evaluacion.estado == 'NA' %}bg-secondary{% else %}bg-warning text-dark{% endif %}">
                    {{ evaluacion.get_estado_display }}
                </span>
            </div>
            <div class="col-auto">
                <strong>Sede:</strong> {{ sede.nombre }}
            </div>
        </div>
    </div>
</div>

<!-- Subir Documento (solo para usuarios que pueden editar) -->
{% if not user.solo_lectura %}
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <h6 class="mb-0"><i class="bi bi-upload"></i> Subir Documento</h6>
    </div>
    <div class="card-body">
        <form id="formSubirArchivo" enctype="multipart/form-data">
            {% csrf_token %}
            <div class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label">Archivo</label>
                    <input type="file" class="form-control" id="archivo" name="archivo" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Nombre (opcional)</label>
                    <input type="text" class="form-control" id="nombreArchivo" name="nombre"
                           placeholder="Si no se especifica, se usa el nombre del archivo">
                </div>
                <div class="col-md-3">
                    <label class="form-label">Descripcion (opcional)</label>
                    <input type="text" class="form-control" id="descripcionArchivo" name="descripcion">
                </div>
                <div class="col-md-1">
                    <button type="submit" class="btn btn-primary w-100">
                        <i class="bi bi-upload"></i>
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
{% else %}
<div class="alert alert-info mb-4">
    <i class="bi bi-info-circle"></i> <strong>Modo solo lectura:</strong>
    Como auditor, puede visualizar los documentos en linea pero no descargarlos ni modificarlos.
</div>
{% endif %}

<!-- Lista de Documentos -->
<div class="card">
    <div class="card-header bg-white">
        <h6 class="mb-0">
            <i class="bi bi-files"></i> Documentos Subidos
            <span class="badge bg-primary">{{ archivos.count }}</span>
        </h6>
    </div>
    {% if archivos %}
    <div class="table-responsive">
        <table class="table table-hover mb-0">
            <thead class="table-light">
                <tr>
                    <th>Nombre</th>
                    <th>Descripcion</th>
                    <th>Fecha</th>
                    <th>Subido por</th>
                    <th style="width: 120px;">Acciones</th>
                </tr>
            </thead>
            <tbody id="listaArchivos">
                {% for archivo in archivos %}
                <tr id="archivo-{{ archivo.pk }}">
                    <td>
                        {% if archivo.es_imagen %}
                        <i class="bi bi-file-image text-success"></i>
                        {% elif archivo.es_pdf %}
                        <i class="bi bi-file-pdf text-danger"></i>
                        {% elif archivo.es_word %}
                        <i class="bi bi-file-earmark-word text-primary"></i>
                        {% elif archivo.es_excel %}
                        <i class="bi bi-file-earmark-excel text-success"></i>
                        {% else %}
                        <i class="bi bi-file-earmark"></i>
                        {% endif %}
                        {% if user.solo_lectura %}
                        <span class="text-dark fw-medium">{{ archivo.nombre }}</span>
                        {% if archivo.es_previsualizable %}
                        <span class="badge bg-info ms-1"><i class="bi bi-eye"></i> Vista previa</span>
                        {% endif %}
                        {% else %}
                        <a href="{{ archivo.archivo.url }}" target="_blank">{{ archivo.nombre }}</a>
                        {% endif %}
                    </td>
                    <td class="text-muted small">{{ archivo.descripcion|default:"-" }}</td>
                    <td class="small">{{ archivo.fecha_subida|date:"d/m/Y H:i" }}</td>
                    <td class="small">{{ archivo.subido_por.nombre_completo|default:archivo.subido_por.email }}</td>
                    <td>
                        {% if user.solo_lectura %}
                        <button type="button" class="btn btn-sm btn-outline-info"
                                onclick="previsualizarArchivo({{ archivo.pk }}, '{{ archivo.nombre }}', '{{ archivo.tipo_archivo }}')"
                                title="Ver documento">
                            <i class="bi bi-eye"></i> Ver
                        </button>
                        {% else %}
                        <div class="btn-group btn-group-sm">
                            <a href="{{ archivo.archivo.url }}" class="btn btn-outline-primary" target="_blank"
                               title="Descargar">
                                <i class="bi bi-download"></i>
                            </a>
                            <button type="button" class="btn btn-outline-danger"
                                    onclick="eliminarArchivo({{ archivo.pk }})" title="Eliminar">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="card-body text-center text-muted">
        <i class="bi bi-folder2 display-4"></i>
        <p class="mt-2">No hay documentos subidos para este criterio.</p>
    </div>
    {% endif %}
</div>

<!-- Modal de Previsualizacion -->
<div class="modal fade" id="modalPreview" tabindex="-1" aria-labelledby="modalPreviewLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalPreviewLabel">
                    <i class="bi bi-eye"></i> <span id="previewNombreArchivo">Documento</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
            </div>
            <div class="modal-body p-0" style="min-height: 70vh;">
                <div id="previewContainer" class="h-100 w-100">
                    <!-- El contenido se carga dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <span class="text-muted me-auto">
                    <i class="bi bi-shield-lock"></i> Modo solo lectura - No se permite descargar
                </span>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Libreria para previsualizar Word (.docx) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
<!-- Libreria para previsualizar Excel (.xlsx) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
const csrfToken = '{{ csrf_token }}';

// Funcion para previsualizar archivos (auditor)
function previsualizarArchivo(archivoId, nombre, tipo) {
    const container = document.getElementById('previewContainer');
    document.getElementById('previewNombreArchivo').textContent = nombre;

    // URL de preview que sirve el archivo con headers correctos
    const previewUrl = `/evaluacion/preview-archivo/${archivoId}/`;

    let contenido = '';

    switch(tipo) {
        case 'pdf':
            // PDFs se muestran en iframe con toolbar deshabilitado
            contenido = `
                <iframe src="${previewUrl}#toolbar=0&navpanes=0&scrollbar=1"
                        style="width: 100%; height: 70vh; border: none;"
                        title="${nombre}">
                </iframe>
            `;
            break;

        case 'imagen':
            // Imagenes se muestran directamente
            contenido = `
                <div class="text-center p-3" style="max-height: 70vh; overflow: auto;">
                    <img src="${previewUrl}" alt="${nombre}" class="img-fluid"
                         style="max-height: 65vh;"
                         oncontextmenu="return false;">
                </div>
            `;
            break;

        case 'word':
            // Word - usar mammoth.js para convertir a HTML
            contenido = `
                <div class="preview-loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Cargando documento Word...</p>
                </div>
            `;
            container.innerHTML = contenido;

            // Cargar y convertir el documento Word
            fetch(previewUrl)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    return mammoth.convertToHtml({ arrayBuffer: arrayBuffer });
                })
                .then(result => {
                    container.innerHTML = `
                        <div class="word-content" oncontextmenu="return false;">
                            ${result.value}
                        </div>
                    `;
                    if (result.messages.length > 0) {
                        console.log('Mammoth messages:', result.messages);
                    }
                })
                .catch(error => {
                    console.error('Error al cargar Word:', error);
                    container.innerHTML = `
                        <div class="text-center p-5">
                            <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
                            <h4 class="mt-3">No se pudo cargar el documento</h4>
                            <p class="text-muted">
                                Solo se soportan archivos .docx (Word 2007+).<br>
                                Los archivos .doc antiguos no son compatibles.
                            </p>
                        </div>
                    `;
                });

            // Mostrar modal inmediatamente con loading
            const modalWord = new bootstrap.Modal(document.getElementById('modalPreview'));
            modalWord.show();
            return; // Salir porque ya mostramos el modal

        case 'excel':
            // Excel - usar SheetJS para renderizar como tabla HTML
            contenido = `
                <div class="preview-loading">
                    <div class="spinner-border text-success" role="status">
                        <span class="visually-hidden">Cargando...</span>
                    </div>
                    <p class="mt-3">Cargando documento Excel...</p>
                </div>
            `;
            container.innerHTML = contenido;

            // Cargar y convertir el documento Excel
            fetch(previewUrl)
                .then(response => response.arrayBuffer())
                .then(arrayBuffer => {
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });

                    // Generar tabs para cada hoja
                    let tabsHtml = '<ul class="nav nav-tabs mb-2" role="tablist">';
                    let contentHtml = '<div class="tab-content">';

                    workbook.SheetNames.forEach((sheetName, index) => {
                        const isActive = index === 0 ? 'active' : '';
                        const tabId = 'sheet-' + index;

                        tabsHtml += `
                            <li class="nav-item" role="presentation">
                                <button class="nav-link ${isActive}" data-bs-toggle="tab"
                                        data-bs-target="#${tabId}" type="button">
                                    ${sheetName}
                                </button>
                            </li>
                        `;

                        const worksheet = workbook.Sheets[sheetName];
                        const html = XLSX.utils.sheet_to_html(worksheet, { editable: false });

                        contentHtml += `
                            <div class="tab-pane fade ${index === 0 ? 'show active' : ''}"
                                 id="${tabId}" role="tabpanel">
                                <div class="excel-content" oncontextmenu="return false;">
                                    ${html}
                                </div>
                            </div>
                        `;
                    });

                    tabsHtml += '</ul>';
                    contentHtml += '</div>';

                    container.innerHTML = tabsHtml + contentHtml;
                })
                .catch(error => {
                    console.error('Error al cargar Excel:', error);
                    container.innerHTML = `
                        <div class="text-center p-5">
                            <i class="bi bi-exclamation-triangle display-1 text-warning"></i>
                            <h4 class="mt-3">No se pudo cargar el documento</h4>
                            <p class="text-muted">
                                Solo se soportan archivos .xlsx (Excel 2007+).<br>
                                Los archivos .xls antiguos pueden tener problemas.
                            </p>
                        </div>
                    `;
                });

            // Mostrar modal inmediatamente con loading
            const modalExcel = new bootstrap.Modal(document.getElementById('modalPreview'));
            modalExcel.show();
            return; // Salir porque ya mostramos el modal

        default:
            contenido = `
                <div class="text-center p-5">
                    <i class="bi bi-file-earmark display-1 text-secondary"></i>
                    <h4 class="mt-3">${nombre}</h4>
                    <p class="text-muted">
                        Este tipo de archivo no se puede previsualizar en el navegador.
                    </p>
                    <div class="alert alert-info d-inline-block">
                        <i class="bi bi-info-circle"></i>
                        El documento existe y esta disponible para usuarios autorizados.
                    </div>
                </div>
            `;
    }

    container.innerHTML = contenido;

    // Mostrar el modal
    const modal = new bootstrap.Modal(document.getElementById('modalPreview'));
    modal.show();
}

// Deshabilitar clic derecho en el modal de preview (evitar "Guardar imagen como...")
document.getElementById('modalPreview').addEventListener('contextmenu', function(e) {
    e.preventDefault();
    return false;
});

// Solo agregar el listener si el formulario existe (no existe para auditores)
const formSubir = document.getElementById('formSubirArchivo');
if (formSubir) {
    formSubir.addEventListener('submit', function(e) {
    e.preventDefault();

    const formData = new FormData(this);

    fetch('{% url "evaluacion:api_subir_archivo" evaluacion_pk=evaluacion.pk %}', {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Agregar fila a la tabla
            const tbody = document.getElementById('listaArchivos');
            if (!tbody) {
                location.reload();
                return;
            }

            const tr = document.createElement('tr');
            tr.id = 'archivo-' + data.archivo.id;
            tr.innerHTML = `
                <td>
                    <i class="bi bi-file-earmark"></i>
                    <a href="${data.archivo.url}" target="_blank">${data.archivo.nombre}</a>
                </td>
                <td class="text-muted small">-</td>
                <td class="small">${data.archivo.fecha}</td>
                <td class="small">{{ user.nombre_completo|default:user.email }}</td>
                <td>
                    <div class="btn-group btn-group-sm">
                        <a href="${data.archivo.url}" class="btn btn-outline-primary" target="_blank">
                            <i class="bi bi-download"></i>
                        </a>
                        <button type="button" class="btn btn-outline-danger" onclick="eliminarArchivo(${data.archivo.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            tbody.insertBefore(tr, tbody.firstChild);

            // Limpiar formulario
            this.reset();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al subir el archivo');
    });
});
} // Cierra el if (formSubir)

function eliminarArchivo(archivoId) {
    if (!confirm('Esta seguro de eliminar este archivo?')) return;

    fetch(`/evaluacion/api/eliminar-archivo/${archivoId}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': csrfToken,
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('archivo-' + archivoId).remove();
        } else {
            alert('Error: ' + data.error);
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}
</script>
{% endblock %}

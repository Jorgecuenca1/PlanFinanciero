{% extends 'planfinanciero/base_app.html' %}

{% block title %}{{ titulo }} - Plan Financiero{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'planfinanciero:movimientos_lista' %}">Movimientos</a></li>
<li class="breadcrumb-item active">{{ titulo }}</li>
{% endblock %}

{% block content %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-arrow-repeat me-2"></i>{{ titulo }}
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle me-2"></i>
                    Un traslado mueve recursos de un rubro (origen/debito) a otro rubro (destino/credito).
                    Se crean automaticamente dos movimientos vinculados.
                </div>

                <form method="post">
                    {% csrf_token %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-header bg-danger text-white">
                                    <i class="bi bi-box-arrow-up me-2"></i>Rubro Origen (Debito)
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="id_rubro_origen" class="form-label">Seleccionar Rubro *</label>
                                        <select id="id_rubro_origen" name="rubro_origen" class="form-select select2-rubro" required>
                                            {% if form.rubro_origen.value %}
                                            <option value="{{ form.rubro_origen.value }}" selected>{{ rubro_origen_texto|default:"Rubro seleccionado" }}</option>
                                            {% endif %}
                                        </select>
                                        {% if form.rubro_origen.errors %}
                                        <div class="text-danger small mt-1">{{ form.rubro_origen.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Se restara el valor de este rubro</div>
                                    </div>
                                    <div id="saldo_origen" class="alert alert-secondary d-none">
                                        <small>Saldo disponible: <strong id="saldo_origen_valor">$0</strong></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card bg-light mb-3">
                                <div class="card-header bg-success text-white">
                                    <i class="bi bi-box-arrow-in-down me-2"></i>Rubro Destino (Credito)
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="id_rubro_destino" class="form-label">Seleccionar Rubro *</label>
                                        <select id="id_rubro_destino" name="rubro_destino" class="form-select select2-rubro" required>
                                            {% if form.rubro_destino.value %}
                                            <option value="{{ form.rubro_destino.value }}" selected>{{ rubro_destino_texto|default:"Rubro seleccionado" }}</option>
                                            {% endif %}
                                        </select>
                                        {% if form.rubro_destino.errors %}
                                        <div class="text-danger small mt-1">{{ form.rubro_destino.errors.0 }}</div>
                                        {% endif %}
                                        <div class="form-text">Se sumara el valor a este rubro</div>
                                    </div>
                                    <div id="saldo_destino" class="alert alert-secondary d-none">
                                        <small>Saldo actual: <strong id="saldo_destino_valor">$0</strong></small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {{ form.non_field_errors }}
                    </div>
                    {% endif %}

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_fecha" class="form-label">Fecha de Operacion *</label>
                                {{ form.fecha }}
                                {% if form.fecha.errors %}
                                <div class="text-danger small mt-1">{{ form.fecha.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="id_valor" class="form-label">Valor a Trasladar (COP) *</label>
                                {{ form.valor }}
                                {% if form.valor.errors %}
                                <div class="text-danger small mt-1">{{ form.valor.errors.0 }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="id_documento_soporte" class="form-label">Documento Soporte *</label>
                        {{ form.documento_soporte }}
                        {% if form.documento_soporte.errors %}
                        <div class="text-danger small mt-1">{{ form.documento_soporte.errors.0 }}</div>
                        {% endif %}
                        <div class="form-text">Decreto o Acto Administrativo que autoriza el traslado</div>
                    </div>

                    <div class="mb-3">
                        <label for="id_observaciones" class="form-label">Observaciones</label>
                        {{ form.observaciones }}
                        {% if form.observaciones.errors %}
                        <div class="text-danger small mt-1">{{ form.observaciones.errors.0 }}</div>
                        {% endif %}
                    </div>

                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle me-2"></i>
                        <strong>Validaciones:</strong>
                        <ul class="mb-0 mt-2">
                            <li>El rubro origen debe tener saldo suficiente para el traslado.</li>
                            <li>El rubro origen y destino deben ser diferentes.</li>
                            <li>Una vez registrado, el traslado no puede ser eliminado, solo anulado.</li>
                        </ul>
                    </div>

                    <hr>

                    <div class="d-flex justify-content-between">
                        <a href="{% url 'planfinanciero:movimientos_lista' %}" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-check-lg me-2"></i>Registrar Traslado
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/i18n/es.js"></script>
<script>
$(document).ready(function() {
    function initSelect2(selector) {
        $(selector).select2({
            theme: 'bootstrap-5',
            language: 'es',
            placeholder: 'Escriba para buscar un rubro...',
            allowClear: true,
            minimumInputLength: 2,
            ajax: {
                url: '{% url "planfinanciero:api_buscar_rubros" %}',
                dataType: 'json',
                delay: 300,
                data: function(params) {
                    return {
                        q: params.term
                    };
                },
                processResults: function(data) {
                    return {
                        results: data.results.map(function(item) {
                            return {
                                id: item.id,
                                text: item.codigo + ' - ' + item.nombre,
                                saldo: item.saldo
                            };
                        })
                    };
                },
                cache: true
            },
            templateResult: function(item) {
                if (item.loading) return item.text;
                var $result = $('<div class="d-flex justify-content-between align-items-center">' +
                    '<div><strong>' + item.text.split(' - ')[0] + '</strong><br><small class="text-muted">' +
                    (item.text.split(' - ').slice(1).join(' - ') || '') + '</small></div>' +
                    '<div class="text-end"><small class="text-success">Saldo: $' +
                    (item.saldo ? Number(item.saldo).toLocaleString('es-CO') : '0') + '</small></div></div>');
                return $result;
            },
            templateSelection: function(item) {
                return item.text || item.id;
            }
        });
    }

    initSelect2('#id_rubro_origen');
    initSelect2('#id_rubro_destino');

    // Mostrar saldo al seleccionar rubro origen
    $('#id_rubro_origen').on('select2:select', function(e) {
        var data = e.params.data;
        if (data.saldo !== undefined) {
            $('#saldo_origen').removeClass('d-none');
            $('#saldo_origen_valor').text('$' + Number(data.saldo).toLocaleString('es-CO'));
        }
    });

    $('#id_rubro_origen').on('select2:clear', function() {
        $('#saldo_origen').addClass('d-none');
    });

    // Mostrar saldo al seleccionar rubro destino
    $('#id_rubro_destino').on('select2:select', function(e) {
        var data = e.params.data;
        if (data.saldo !== undefined) {
            $('#saldo_destino').removeClass('d-none');
            $('#saldo_destino_valor').text('$' + Number(data.saldo).toLocaleString('es-CO'));
        }
    });

    $('#id_rubro_destino').on('select2:clear', function() {
        $('#saldo_destino').addClass('d-none');
    });
});
</script>
{% endblock %}

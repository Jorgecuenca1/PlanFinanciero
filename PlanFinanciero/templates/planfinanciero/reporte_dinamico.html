{% extends 'planfinanciero/base_app.html' %}

{% block title %}{{ titulo }} - Plan Financiero{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'planfinanciero:reportes' %}">Reportes</a></li>
<li class="breadcrumb-item active">{{ titulo }}</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">{{ titulo }}</h1>
        <p class="page-subtitle">Resumen agrupado por {{ columna_grupo }}</p>
    </div>
    <div>
        <a href="{% url 'planfinanciero:reportes' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Volver
        </a>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>{{ columna_grupo }}</th>
                        <th class="text-center">Rubros</th>
                        <th class="text-end">P. Inicial</th>
                        <th class="text-end">Adiciones</th>
                        <th class="text-end">Reducciones</th>
                        <th class="text-end">Trasl. Cred</th>
                        <th class="text-end">Trasl. Deb</th>
                        <th class="text-end">Saldo Actual</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in datos %}
                    <tr>
                        <td>
                            <strong>{{ item.nombre }}</strong>
                            {% if item.codigo and item.codigo != '-' %}
                            <br><small class="text-muted">{{ item.codigo }}</small>
                            {% endif %}
                        </td>
                        <td class="text-center">
                            <span class="badge bg-secondary">{{ item.cantidad }}</span>
                        </td>
                        <td class="text-end">${{ item.inicial|floatformat:0 }}</td>
                        <td class="text-end text-success">${{ item.adiciones|floatformat:0 }}</td>
                        <td class="text-end text-danger">${{ item.reducciones|floatformat:0 }}</td>
                        <td class="text-end text-info">${{ item.traslados_credito|floatformat:0 }}</td>
                        <td class="text-end text-warning">${{ item.traslados_debito|floatformat:0 }}</td>
                        <td class="text-end fw-bold">${{ item.saldo|floatformat:0 }}</td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="8" class="text-center text-muted">No hay datos para mostrar</td>
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-primary">
                    <tr class="fw-bold">
                        <td>TOTAL GENERAL</td>
                        <td class="text-center">{{ datos|length }}</td>
                        <td class="text-end">${{ gran_total.inicial|floatformat:0 }}</td>
                        <td class="text-end">${{ gran_total.adiciones|floatformat:0 }}</td>
                        <td class="text-end">${{ gran_total.reducciones|floatformat:0 }}</td>
                        <td class="text-end">${{ gran_total.traslados_credito|floatformat:0 }}</td>
                        <td class="text-end">${{ gran_total.traslados_debito|floatformat:0 }}</td>
                        <td class="text-end">${{ gran_total.saldo|floatformat:0 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Grafico visual -->
<div class="card mt-4">
    <div class="card-header">
        <i class="bi bi-bar-chart me-2"></i>Distribucion del Saldo por {{ columna_grupo }}
    </div>
    <div class="card-body">
        {% for item in datos %}
        {% if gran_total.saldo > 0 %}
        {% widthratio item.saldo gran_total.saldo 100 as porcentaje %}
        {% else %}
        {% with porcentaje=0 %}
        {% endwith %}
        {% endif %}
        <div class="mb-3">
            <div class="d-flex justify-content-between mb-1">
                <span>{{ item.nombre }}</span>
                <span class="fw-bold">${{ item.saldo|floatformat:0 }}</span>
            </div>
            <div class="progress" style="height: 20px;">
                <div class="progress-bar bg-primary" role="progressbar"
                     style="width: {% widthratio item.saldo gran_total.saldo 100 %}%">
                    {% widthratio item.saldo gran_total.saldo 100 %}%
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
</div>
{% endblock %}

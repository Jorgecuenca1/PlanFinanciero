{% extends 'planfinanciero/base_app.html' %}
{% load planfinanciero_tags %}

{% block title %}{{ titulo }} - Plan Financiero{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'planfinanciero:reportes' %}">Reportes</a></li>
<li class="breadcrumb-item active">Tabla Cruzada</li>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h1 class="page-title">{{ titulo }}</h1>
        <p class="page-subtitle">Analisis bidimensional del presupuesto</p>
    </div>
    <div>
        <a href="{% url 'planfinanciero:reportes' %}" class="btn btn-outline-secondary">
            <i class="bi bi-arrow-left me-1"></i> Volver
        </a>
    </div>
</div>

<!-- Tabla de Saldos -->
<div class="card mb-4">
    <div class="card-header bg-primary text-white">
        <i class="bi bi-grid-3x3 me-2"></i>Saldo Actual por Nivel y Clase de Ingreso
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered">
                <thead class="table-dark">
                    <tr>
                        <th>Nivel</th>
                        {% for clase_code, clase_name in clases %}
                        <th class="text-end">{{ clase_name }}</th>
                        {% endfor %}
                        <th class="text-end bg-secondary">Total Nivel</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nivel_code, nivel_name in niveles %}
                    <tr>
                        <td class="fw-bold">{{ nivel_name }}</td>
                        {% with nivel_data=matriz|get_item:nivel_code %}
                        {% for clase_code, clase_name in clases %}
                        {% with clase_data=nivel_data|get_item:clase_code %}
                        <td class="text-end">${{ clase_data.saldo|floatformat:0 }}</td>
                        {% endwith %}
                        {% endfor %}
                        <!-- Total del nivel -->
                        <td class="text-end fw-bold bg-light">
                            {% with total=0 %}
                            {% for clase_code, clase_name in clases %}
                            {% with clase_data=nivel_data|get_item:clase_code %}
                            {% endwith %}
                            {% endfor %}
                            {% endwith %}
                            ${% for clase_code, clase_name in clases %}{% with clase_data=nivel_data|get_item:clase_code %}{{ clase_data.saldo|add:0 }}{% endwith %}{% if not forloop.last %}+{% endif %}{% endfor %}
                        </td>
                        {% endwith %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot class="table-primary">
                    <tr class="fw-bold">
                        <td>Total Clase</td>
                        {% for clase_code, clase_name in clases %}
                        {% with clase_total=totales_clase|get_item:clase_code %}
                        <td class="text-end">${{ clase_total.saldo|floatformat:0 }}</td>
                        {% endwith %}
                        {% endfor %}
                        <td class="text-end bg-success text-white">${{ gran_total.saldo|floatformat:0 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Tabla de Presupuesto Inicial -->
<div class="card mb-4">
    <div class="card-header bg-info text-white">
        <i class="bi bi-cash me-2"></i>Presupuesto Inicial por Nivel y Clase
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-bordered table-sm">
                <thead class="table-secondary">
                    <tr>
                        <th>Nivel</th>
                        {% for clase_code, clase_name in clases %}
                        <th class="text-end">{{ clase_name }}</th>
                        {% endfor %}
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody>
                    {% for nivel_code, nivel_name in niveles %}
                    <tr>
                        <td>{{ nivel_name }}</td>
                        {% with nivel_data=matriz|get_item:nivel_code %}
                        {% for clase_code, clase_name in clases %}
                        {% with clase_data=nivel_data|get_item:clase_code %}
                        <td class="text-end">${{ clase_data.inicial|floatformat:0 }}</td>
                        {% endwith %}
                        {% endfor %}
                        <td class="text-end fw-bold">-</td>
                        {% endwith %}
                    </tr>
                    {% endfor %}
                </tbody>
                <tfoot>
                    <tr class="fw-bold table-light">
                        <td>Total</td>
                        {% for clase_code, clase_name in clases %}
                        {% with clase_total=totales_clase|get_item:clase_code %}
                        <td class="text-end">${{ clase_total.inicial|floatformat:0 }}</td>
                        {% endwith %}
                        {% endfor %}
                        <td class="text-end">${{ gran_total.inicial|floatformat:0 }}</td>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>
</div>

<!-- Resumen General -->
<div class="row">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-success text-white">
                <i class="bi bi-plus-circle me-2"></i>Resumen de Adiciones
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    {% for clase_code, clase_name in clases %}
                    {% with clase_total=totales_clase|get_item:clase_code %}
                    <tr>
                        <td>{{ clase_name }}</td>
                        <td class="text-end">${{ clase_total.adiciones|floatformat:0 }}</td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                    <tr class="fw-bold table-success">
                        <td>Total</td>
                        <td class="text-end">${{ gran_total.adiciones|floatformat:0 }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-header bg-danger text-white">
                <i class="bi bi-dash-circle me-2"></i>Resumen de Reducciones
            </div>
            <div class="card-body">
                <table class="table table-sm mb-0">
                    {% for clase_code, clase_name in clases %}
                    {% with clase_total=totales_clase|get_item:clase_code %}
                    <tr>
                        <td>{{ clase_name }}</td>
                        <td class="text-end">${{ clase_total.reducciones|floatformat:0 }}</td>
                    </tr>
                    {% endwith %}
                    {% endfor %}
                    <tr class="fw-bold table-danger">
                        <td>Total</td>
                        <td class="text-end">${{ gran_total.reducciones|floatformat:0 }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Traslados -->
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-warning text-dark">
                <i class="bi bi-arrow-left-right me-2"></i>Resumen de Traslados
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-6">
                        <h5 class="text-info">Traslados Credito (Recibidos)</h5>
                        <h3>${{ gran_total.traslados_credito|floatformat:0 }}</h3>
                    </div>
                    <div class="col-md-6">
                        <h5 class="text-warning">Traslados Debito (Enviados)</h5>
                        <h3>${{ gran_total.traslados_debito|floatformat:0 }}</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% extends 'planfinanciero/base_app.html' %}
{% load humanize %}

{% block title %}Dashboard - Plan Financiero{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item active">Dashboard</li>
{% endblock %}

{% block content %}
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
    <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle mb-0">Resumen del estado financiero actual</p>
    </div>
    <a href="{% url 'planfinanciero:movimiento_crear' %}" class="btn btn-primary">
        <i class="bi bi-plus-lg me-2"></i>Nuevo Movimiento
    </a>
</div>

<!-- Stats Cards -->
<div class="row g-3 mb-4">
    <div class="col-6 col-lg-3">
        <div class="stat-card h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-2">
                    <div class="stat-label">Presupuesto Inicial</div>
                    <div class="stat-value">${{ total_presupuesto_inicial|floatformat:0|intcomma }}</div>
                </div>
                <div class="stat-icon d-none d-sm-flex" style="background: #dbeafe; color: #2563eb;">
                    <i class="bi bi-wallet2"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-2">
                    <div class="stat-label">Total Adiciones</div>
                    <div class="stat-value text-success">+${{ total_adiciones|floatformat:0|intcomma }}</div>
                </div>
                <div class="stat-icon d-none d-sm-flex" style="background: #dcfce7; color: #16a34a;">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-2">
                    <div class="stat-label">Total Reducciones</div>
                    <div class="stat-value text-danger">-${{ total_reducciones|floatformat:0|intcomma }}</div>
                </div>
                <div class="stat-icon d-none d-sm-flex" style="background: #fee2e2; color: #dc2626;">
                    <i class="bi bi-graph-down-arrow"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-6 col-lg-3">
        <div class="stat-card h-100">
            <div class="d-flex justify-content-between align-items-start">
                <div class="flex-grow-1 me-2">
                    <div class="stat-label">Saldo Definitivo</div>
                    <div class="stat-value">${{ total_saldo|floatformat:0|intcomma }}</div>
                </div>
                <div class="stat-icon d-none d-sm-flex" style="background: #f3e8ff; color: #9333ea;">
                    <i class="bi bi-cash-stack"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Stats Row -->
<div class="row g-4 mb-4">
    <div class="col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-label">Rubros Activos</div>
                    <div class="stat-value">{{ total_rubros }}</div>
                </div>
                <a href="{% url 'planfinanciero:rubros_lista' %}" class="btn btn-outline-primary btn-sm">
                    Ver todos <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="stat-card">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <div class="stat-label">Movimientos Registrados</div>
                    <div class="stat-value">{{ total_movimientos }}</div>
                </div>
                <a href="{% url 'planfinanciero:movimientos_lista' %}" class="btn btn-outline-primary btn-sm">
                    Ver todos <i class="bi bi-arrow-right ms-1"></i>
                </a>
            </div>
        </div>
    </div>
</div>

<div class="row g-4">
    <!-- Últimos Movimientos -->
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span><i class="bi bi-clock-history me-2"></i>Ultimos Movimientos</span>
                <a href="{% url 'planfinanciero:movimientos_lista' %}" class="btn btn-sm btn-outline-secondary">Ver todos</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead>
                            <tr>
                                <th>Fecha</th>
                                <th>Tipo</th>
                                <th>Rubro</th>
                                <th class="text-end">Valor</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for mov in ultimos_movimientos %}
                            <tr>
                                <td>{{ mov.fecha|date:"d/m/Y" }}</td>
                                <td>
                                    <span class="badge badge-tipo badge-{% if mov.tipo == 'INICIAL' %}inicial{% elif mov.tipo == 'ADICION' %}adicion{% elif mov.tipo == 'REDUCCION' %}reduccion{% else %}traslado{% endif %}">
                                        {{ mov.get_tipo_display }}
                                    </span>
                                </td>
                                <td>
                                    <a href="{% url 'planfinanciero:rubro_detalle' mov.rubro.pk %}" class="text-decoration-none">
                                        {{ mov.rubro.codigo }}
                                    </a>
                                </td>
                                <td class="text-end currency {% if mov.tipo in 'REDUCCION,TRASLADO_DEBITO' %}currency-negative{% else %}currency-positive{% endif %}">
                                    {% if mov.tipo in 'REDUCCION,TRASLADO_DEBITO' %}-{% else %}+{% endif %}${{ mov.valor|floatformat:0|intcomma }}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center text-muted py-4">
                                    <i class="bi bi-inbox fs-1 d-block mb-2"></i>
                                    No hay movimientos registrados
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Rubros con Mayor Saldo -->
    <div class="col-lg-4">
        <div class="card">
            <div class="card-header">
                <i class="bi bi-trophy me-2"></i>Top 5 Rubros por Saldo
            </div>
            <div class="card-body p-0">
                <ul class="list-group list-group-flush">
                    {% for rubro in rubros_top %}
                    <li class="list-group-item">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <a href="{% url 'planfinanciero:rubro_detalle' rubro.pk %}" class="text-decoration-none fw-medium">
                                    {{ rubro.codigo }}
                                </a>
                                <div class="text-muted small text-truncate" style="max-width: 200px;">
                                    {{ rubro.nombre }}
                                </div>
                            </div>
                            <span class="badge bg-primary">${{ rubro.saldo_actual|floatformat:0|intcomma }}</span>
                        </div>
                    </li>
                    {% empty %}
                    <li class="list-group-item text-center text-muted py-4">
                        No hay rubros registrados
                    </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!-- Acciones Rápidas -->
        <div class="card mt-4">
            <div class="card-header">
                <i class="bi bi-lightning me-2"></i>Acciones Rapidas
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <a href="{% url 'planfinanciero:movimiento_crear' %}" class="btn btn-outline-primary">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Mov. Ingresos
                    </a>
                    <a href="{% url 'planfinanciero:gastos_movimiento_crear' %}" class="btn btn-outline-warning">
                        <i class="bi bi-plus-circle me-2"></i>Nuevo Mov. Gastos
                    </a>
                    <a href="{% url 'planfinanciero:rubro_crear' %}" class="btn btn-outline-secondary">
                        <i class="bi bi-database-add me-2"></i>Crear Rubro
                    </a>
                    <a href="{% url 'planfinanciero:exportar_excel' %}" class="btn btn-outline-success">
                        <i class="bi bi-file-earmark-excel me-2"></i>Exportar Excel
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
